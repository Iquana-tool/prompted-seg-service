# Use a lightweight Python base image
FROM nvidia/cuda:13.0.1-cudnn-devel-ubuntu24.04

# Install system dependencies (git + any required libraries)
# Also python and pip
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    libgl1 \
    libglib2.0-0 \
    python3 python3-pip python3-venv\
    curl && \
    rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Add uv to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Verify uv is accessible
RUN uv --version

# Copy only the files needed for dependency installation
COPY . .

# Sync dependencies using uv
RUN uv sync --no-cache

# Install torch with CUDA support
RUN uv pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124 --no-cache-dir

# Clone and install sam2 from GitHub
RUN git clone https://github.com/facebookresearch/sam2.git && \
    cd sam2 && \
    SAM2_BUILD_CUDA=1 uv pip install . --no-cache-dir && \
    cd .. && rm -rf sam2

# Expose the FastAPI port (default: 8000)
EXPOSE 8000

RUN uv pip freeze

# Run the FastAPI app using uvicorn
CMD ["uv", "run", "fastapi", "run", "main.py", "--port", "8000"]
